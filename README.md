# Анализ фрагмента проекта и рефакторинг

Для анализа была выбрана подсистема печати документов в одном из старых проектов.

В системе нужно печатать документы: счета, акты, накладные и т.п.

Данные для документа читаются из модели (загруженной из базы) и подставляются в шаблон.
Шаблон может быть в формате php, docx или xlsx. После подстановки шаблон сохраняется в целевой документ: либо в файл на диске (в некоем файловом хранилище на бэкенде),
либо отправляется пользователю в браузер.

Для реализации этой задачи был разработан базовый класс `PrintForm` (см. файл `v1/PrintForm.php`).
Разработчик должен был отнаследоваться от этого класса и переопределением переменных и методов настроить печатную форму, а именно:
- указать файл шаблона php, docx или xlsx (файл шаблона с плейсхолдерами добавляется в репозиторий рядом с классом унаследованным от `PrintForm`)
- написать маппер данных из модели в переменные шаблона
- задать выходное действие: сохранять в файловое хранилище или сразу отправлять пользователю
- написать функцию, формирующую имя результирующего файла (обычно имя формируется на основе данных модели, например "Акт <номер> от <дата>.xlsx")

Проблема базового класса `PrintForm` была в том, что он содержал в себе слишком много логики, слишком много кода. Иногда, при добавлении новых фич в базовый класс `PrintForm`, например, для улучшения печати в docx файлы, ломалась печать в xlsx файлы. В базовом классе `PrintForm` было сложно разбираться.


В данной работе я провёл анализ и рефакторинг класс `PrintForm` (см. папку v2).
Конечный программист должен сформировать некое описание печатной формы в коде и приложить файл шаблона - это должно быть максимально легко и удобно. Движок печати по сформированному описанию должен сгенерировать конечный файл, подставив данные в шаблон. 

В первую очередь я вынес в отдельный интерфейс всю функциональность, которую мы даём конечному программисту для настройки конкретной печатной формы.

Интерфейс `IPrintForm` требует описать три метода:

1. `public function createTemplate(): ITemplate` - этот метод возвращает движку объект описывающий формат шаблона и привязанный к конкретному файлу шаблона. В поставке идёт три готовых класса `ITemplate` для формирования Excel, Html и PDF файлов (планирую добавить ещё Word).

2. `public function mapData(Model $model): array;` - метод подготавливает данные для подстановки в плейсхолдеры в шаблоне

3. `public function getFilename(Model $model): string;` - метод определяющий имя конечного файла на основе данных модели (обычно имя файла напрямую зависит от данных, например "Акт <номер> от <дата>.xlsx").

Все три метода интерфейса `IPrintForm` сопряжены с описанием печатной формы - они целиком и полностью определяют печатную форму поэтому их удобно определять одновременно в одном классе.

Примеры реализации этого интерфейса: `v2/ActPrintForm.php` и `v2/InvoicePrintForm.php`.

Вся функциональность, связанная с формированием документа на основе описания (на основе класс имплементирующего `IPrintForm`) вынесена в класс `Printer` (`v2/PrintForm/Printer.php`). Принтер принимает на вход модель с данными и объект печатной формы, выдаёт результирующий файл. Пример использования принтера в `v2/index.php`.


